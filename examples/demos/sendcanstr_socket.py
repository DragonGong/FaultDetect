import socket
import time
import sys
import can
import cantools
import json
# generated by llm
# ========== TCP é…ç½® ==========
SERVER_IP = '127.0.0.1'
SERVER_PORT = 12345
RECONNECT_DELAY = 2  # é‡è¿é—´éš”ï¼ˆç§’ï¼‰
# ==============================

# ========== CAN é…ç½® ==========
DBC_FILE = 'assets/20250409.dbc'
CAN_CHANNEL = 0
BITRATE = 500000
TARGET_SIGNAL = 'SGW_IBC_PedalTravelSensorSt'
# ==============================

# åŠ è½½ DBC
db = cantools.database.load_file(DBC_FILE)

# åˆå§‹åŒ– CAN æ€»çº¿
bus = can.interface.Bus(
    interface='kvaser',
    channel=CAN_CHANNEL,
    bitrate=BITRATE
)

print("ğŸ“¡ Listening on CAN bus and forwarding via TCP...")


def connect_to_server():
    """å°è¯•è¿æ¥æœåŠ¡å™¨ï¼Œå¤±è´¥è¿”å› None"""
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        client_socket.connect((SERVER_IP, SERVER_PORT))
        print(f"âœ… Connected to server at {SERVER_IP}:{SERVER_PORT}")
        return client_socket
    except Exception as e:
        print(f"âŒ Connection failed: {e}")
        return None


def main():
    client_socket = None

    try:
        while True:
            # æ¥æ”¶ CAN æ¶ˆæ¯ï¼ˆå¸¦è¶…æ—¶ï¼Œé¿å…é˜»å¡ï¼‰
            msg = bus.recv(timeout=0.1)  # ä½¿ç”¨çŸ­è¶…æ—¶ï¼Œé¿å…å¡æ­»
            if msg is None:
                # å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€æˆ–é‡è¿
                if client_socket is None:
                    client_socket = connect_to_server()
                    time.sleep(RECONNECT_DELAY if client_socket is None else 0.01)
                continue

            try:
                decoded = db.decode_message(msg.arbitration_id, msg.data)

                # æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡ä¿¡å·
                if TARGET_SIGNAL in decoded:
                    # æ„é€ è¦å‘é€çš„æ•°æ®ç»“æ„
                    data_to_send = {
                        "timestamp": time.time(),
                        "can_id": hex(msg.arbitration_id),
                        "signals": decoded
                    }

                    # åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²
                    message = json.dumps(data_to_send) + "\n"

                    # å¦‚æœæœªè¿æ¥ï¼Œå°è¯•è¿æ¥
                    if client_socket is None:
                        client_socket = connect_to_server()
                        if client_socket is None:
                            continue  # è·³è¿‡æœ¬æ¬¡å‘é€

                    # å°è¯•å‘é€
                    try:
                        client_socket.send(message.encode('utf-8'))
                        print(f"ğŸ“¤ Sent: {list(decoded.keys())} @ {time.strftime('%H:%M:%S')}")
                    except (BrokenPipeError, ConnectionResetError, OSError):
                        print("âš ï¸ Connection lost. Reconnecting...")
                        client_socket.close()
                        client_socket = None

            except Exception as e:
                # è§£ç å¤±è´¥ä¸ä¸­æ–­ï¼Œç»§ç»­ç›‘å¬
                continue

    except KeyboardInterrupt:
        print("\nğŸ›‘ User interrupted. Closing...")
    finally:
        bus.shutdown()
        if client_socket:
            client_socket.close()
        print("ğŸ‘‹ CAN TCP Client exited.")


if __name__ == '__main__':
    main()